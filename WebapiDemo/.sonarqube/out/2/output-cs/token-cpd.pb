Ëq
>E:\CX\WebapiDemo\WebApiDemo.DAL\ComprehensiveSectionPostDal.cs
	namespace 	

WebApiDemo
 
. 
DAL 
{ 
public		 

class		 '
ComprehensiveSectionPostDal		 ,
:		- .
IPostDal		/ 7
{

 
public 
List 
< 
Post 
? 
> 
? 
GetAllPosts '
(' (
)( )
{ 	
using 
var 
context 
= 
DbContextFactory  0
.0 1
GetDbContext1 =
(= >
)> ?
;? @
List 
< 
Post 
? 
> 
posts 
= 
context  '
.' (%
ComprehensiveSectionPosts( A
.A B
ToListB H
(H I
)I J
.J K
OfTypeK Q
<Q R
PostR V
?V W
>W X
(X Y
)Y Z
.Z [
ToList[ a
(a b
)b c
;c d
if 
( 
posts 
== 
null 
) 
{ 
return 
null 
; 
} 
return 
posts 
; 
} 	
public 
List 
< 
Post 
? 
> 
? 
GetPosts $
($ %
int% (

beginIndex) 3
,3 4
int5 8
needNum9 @
)@ A
{ 	
using 
var 
context 
= 
DbContextFactory  0
.0 1
GetDbContext1 =
(= >
)> ?
;? @
List 
< 
Post 
? 
> 
posts 
= 
context  '
.' (%
ComprehensiveSectionPosts( A
. 
Skip 
( 

beginIndex  
)  !
. 
Take 
( 
needNum 
) 
. 
ToList 
( 
) 
. 
OfType 
< 
Post 
? 
> 
( 
)  
. 
ToList 
( 
) 
; 
if 
( 
posts 
== 
null 
) 
{   
return!! 
null!! 
;!! 
}"" 
return## 
posts## 
;## 
}$$ 	
public&& 
List&& 
<&& 
Post&& 
?&& 
>&& 
?&& 
GetPosts&& $
(&&$ %
int&&% (

mainPostId&&) 3
)&&3 4
{'' 	
using(( 
var(( 
context(( 
=(( 
DbContextFactory((  0
.((0 1
GetDbContext((1 =
(((= >
)((> ?
;((? @
Post)) 
?)) 
mainPost)) 
=)) 
context)) $
.))$ %%
ComprehensiveSectionPosts))% >
.))> ?
Find))? C
())C D

mainPostId))D N
)))N O
;))O P
if** 
(** 
mainPost** 
==** 
null**  
)**  !
{++ 
return,, 
null,, 
;,, 
}-- 
List// 
<// 
Post// 
?// 
>// 
posts// 
=// 
new//  #
List//$ (
<//( )
Post//) -
?//- .
>//. /
{//0 1
mainPost//2 :
}//; <
;//< =
posts11 
.11 
AddRange11 
(11 
context11 "
.11" #%
ComprehensiveSectionPosts11# <
.22 
Where22 
(22 
p22 
=>22 
p22 
.22 

MainPostId22 (
==22) +

mainPostId22, 6
)226 7
.33 
ToList33 
(33 
)33 
.44 
OfType44 
<44 
Post44 
?44 
>44 
(44 
)44  
.55 
ToList55 
(55 
)55 
)55 
;55 
posts88 
.88 
Sort88 
(88 
(88 
p188 
,88 
p288 
)88 
=>88  "
p188# %
?88% &
.88& '
PublishTime88' 2
.882 3
	CompareTo883 <
(88< =
p288= ?
?88? @
.88@ A
PublishTime88A L
)88L M
??88N P
$num88Q R
)88R S
;88S T
return99 
posts99 
;99 
}:: 	
public<< 
Post<< 
?<< 
GetPostById<<  
(<<  !
int<<! $
id<<% '
)<<' (
{== 	
using>> 
var>> 
context>> 
=>> 
DbContextFactory>>  0
.>>0 1
GetDbContext>>1 =
(>>= >
)>>> ?
;>>? @
return?? 
context?? 
.?? %
ComprehensiveSectionPosts?? 4
.??4 5
Find??5 9
(??9 :
id??: <
)??< =
;??= >
}@@ 	
publicBB 
intBB 
AddPostBB 
(BB 
PostBB 
postBB  $
)BB$ %
{CC 	
usingDD 
varDD 
contextDD 
=DD 
DbContextFactoryDD  0
.DD0 1
GetDbContextDD1 =
(DD= >
)DD> ?
;DD? @
contextEE 
.EE %
ComprehensiveSectionPostsEE -
.EE- .
AddEE. 1
(EE1 2
postEE2 6
.EE6 7&
ToComprehensiveSectionPostEE7 Q
(EEQ R
)EER S
)EES T
;EET U
contextFF 
.FF 
SaveChangesFF 
(FF  
)FF  !
;FF! "
returnII 
contextII 
.II %
ComprehensiveSectionPostsII 4
.JJ 
OrderByDescendingJJ &
(JJ& '
pJJ' (
=>JJ) +
pJJ, -
.JJ- .
IdJJ. 0
)JJ0 1
.KK 
FirstOrDefaultKK #
(KK# $
)KK$ %
?LL 
.LL 
IdLL 
??LL 
-LL 
$numLL 
;LL 
}MM 	
publicOO 
voidOO 
SetMainPostOO 
(OO  
intOO  #
idOO$ &
)OO& '
{PP 	
usingQQ 
varQQ 
contextQQ 
=QQ 
DbContextFactoryQQ  0
.QQ0 1
GetDbContextQQ1 =
(QQ= >
)QQ> ?
;QQ? @
varRR 
postRR 
=RR 
contextRR 
.RR %
ComprehensiveSectionPostsRR 8
.RR8 9
FindRR9 =
(RR= >
idRR> @
)RR@ A
;RRA B
ifSS 
(SS 
postSS 
!=SS 
nullSS 
)SS 
{TT 
postUU 
.UU 

IsMainPostUU 
=UU  !
trueUU" &
;UU& '
contextVV 
.VV 
SaveChangesVV #
(VV# $
)VV$ %
;VV% &
}WW 
}XX 	
publicZZ 
ListZZ 
<ZZ 

UserBModelZZ 
?ZZ 
>ZZ  
?ZZ  !
GetAllUsersZZ" -
(ZZ- .
)ZZ. /
{[[ 	
using\\ 
var\\ 
context\\ 
=\\ 
DbContextFactory\\  0
.\\0 1
GetDbContext\\1 =
(\\= >
)\\> ?
;\\? @
var]] 
userIds]] 
=]] 
context]] !
.]]! "%
ComprehensiveSectionPosts]]" ;
.^^ 
Select^^ 
(^^ 
p^^ 
=>^^ 
p^^ 
.^^ 
UserId^^ %
)^^% &
.__ 
Distinct__ 
(__ 
)__ 
.`` 
ToList`` 
(`` 
)`` 
;`` 
varaa 
usersaa 
=aa 
userIdsaa 
.aa  
Selectaa  &
(aa& '
idaa' )
=>aa* ,
contextaa- 4
.aa4 5
Usersaa5 :
.aa: ;
Findaa; ?
(aa? @
idaa@ B
)aaB C
?aaC D
.aaD E
ToUserBModelaaE Q
(aaQ R
)aaR S
)aaS T
.aaT U
ToListaaU [
(aa[ \
)aa\ ]
;aa] ^
ifbb 
(bb 
usersbb 
==bb 
nullbb 
)bb 
{cc 
returndd 
nulldd 
;dd 
}ee 
returnff 
usersff 
;ff 
}gg 	
publicii 
Listii 
<ii 

UserBModelii 
?ii 
>ii  
?ii  !
GetUsersii" *
(ii* +
intii+ .
beginNumii/ 7
,ii7 8
intii9 <
needNumii= D
)iiD E
{jj 	
usingkk 
varkk 
contextkk 
=kk 
DbContextFactorykk  0
.kk0 1
GetDbContextkk1 =
(kk= >
)kk> ?
;kk? @
varll 
userIdsll 
=ll 
contextll !
.ll! "%
ComprehensiveSectionPostsll" ;
.mm 
Selectmm 
(mm 
pmm 
=>mm 
pmm 
.mm 
UserIdmm %
)mm% &
.nn 
Distinctnn 
(nn 
)nn 
.oo 
Skipoo 
(oo 
beginNumoo 
)oo 
.pp 
Takepp 
(pp 
needNumpp 
)pp 
.qq 
ToListqq 
(qq 
)qq 
;qq 
varrr 
usersrr 
=rr 
userIdsrr 
.rr  
Selectrr  &
(rr& '
idrr' )
=>rr* ,
contextrr- 4
.rr4 5
Usersrr5 :
.rr: ;
Findrr; ?
(rr? @
idrr@ B
)rrB C
?rrC D
.rrD E
ToUserBModelrrE Q
(rrQ R
)rrR S
)rrS T
.rrT U
ToListrrU [
(rr[ \
)rr\ ]
;rr] ^
ifss 
(ss 
usersss 
==ss 
nullss 
)ss 
{tt 
returnuu 
nulluu 
;uu 
}vv 
returnww 
usersww 
;ww 
}xx 	
publiczz 
Postzz 
?zz 
GetLastReplyPostszz &
(zz& '
intzz' *

mainPostIdzz+ 5
)zz5 6
{{{ 	
using|| 
var|| 
context|| 
=|| 
DbContextFactory||  0
.||0 1
GetDbContext||1 =
(||= >
)||> ?
;||? @
return}} 
context}} 
.}} %
ComprehensiveSectionPosts}} 4
.~~ 
Where~~ 
(~~ 
p~~ 
=>~~ 
p~~ 
.~~ 

MainPostId~~ (
==~~) +

mainPostId~~, 6
)~~6 7
. 
OrderByDescending "
(" #
p# $
=>% '
p( )
.) *
Id* ,
), -
.
ÄÄ 
FirstOrDefault
ÄÄ 
(
ÄÄ  
)
ÄÄ  !
;
ÄÄ! "
}
ÅÅ 	
public
ÉÉ 
List
ÉÉ 
<
ÉÉ 
Post
ÉÉ 
>
ÉÉ 
?
ÉÉ 
GetMainPosts
ÉÉ '
(
ÉÉ' (
)
ÉÉ( )
{
ÑÑ 	
using
ÖÖ 
var
ÖÖ 
context
ÖÖ 
=
ÖÖ 
DbContextFactory
ÖÖ  0
.
ÖÖ0 1
GetDbContext
ÖÖ1 =
(
ÖÖ= >
)
ÖÖ> ?
;
ÖÖ? @
return
ÜÜ 
context
ÜÜ 
.
ÜÜ '
ComprehensiveSectionPosts
ÜÜ 4
.
áá 
Where
áá 
(
áá 
p
áá 
=>
áá 
p
áá 
.
áá 

IsMainPost
áá (
)
áá( )
.
àà 
ToList
àà 
(
àà 
)
àà 
.
ââ 
OfType
ââ 
<
ââ 
Post
ââ 
>
ââ 
(
ââ 
)
ââ 
.
ää 
ToList
ää 
(
ää 
)
ää 
;
ää 
}
ãã 	
public
çç 
void
çç 

UpdatePost
çç 
(
çç 
Post
çç #
post
çç$ (
)
çç( )
{
éé 	
using
èè 
var
èè 
context
èè 
=
èè 
DbContextFactory
èè  0
.
èè0 1
GetDbContext
èè1 =
(
èè= >
)
èè> ?
;
èè? @
var
êê 
postToUpdate
êê 
=
êê 
context
êê &
.
êê& ''
ComprehensiveSectionPosts
êê' @
.
êê@ A
Find
êêA E
(
êêE F
post
êêF J
.
êêJ K
Id
êêK M
)
êêM N
;
êêN O
if
ëë 
(
ëë 
postToUpdate
ëë 
!=
ëë 
null
ëë  $
)
ëë$ %
{
íí 
postToUpdate
ìì 
.
ìì 
UpVote
ìì #
=
ìì$ %
post
ìì& *
.
ìì* +
UpVote
ìì+ 1
;
ìì1 2
postToUpdate
îî 
.
îî 
DownVote
îî %
=
îî& '
post
îî( ,
.
îî, -
DownVote
îî- 5
;
îî5 6
postToUpdate
ïï 
.
ïï 
ViewNum
ïï $
=
ïï% &
post
ïï' +
.
ïï+ ,
ViewNum
ïï, 3
;
ïï3 4
postToUpdate
ññ 
.
ññ 
ReplyNum
ññ %
=
ññ& '
post
ññ( ,
.
ññ, -
ReplyNum
ññ- 5
;
ññ5 6
context
óó 
.
óó '
ComprehensiveSectionPosts
óó 1
.
óó1 2
Update
óó2 8
(
óó8 9
postToUpdate
óó9 E
)
óóE F
;
óóF G
context
òò 
.
òò 
SaveChanges
òò #
(
òò# $
)
òò$ %
;
òò% &
}
ôô 
}
öö 	
}
õõ 
}úú ±
:E:\CX\WebapiDemo\WebApiDemo.DAL\Factorys\PostDalFactory.cs
	namespace 	

WebApiDemo
 
. 
DAL 
. 
Factorys !
{ 
public		 

class		 
PostDalFactory		 
:		  !
IPostDalFactory		" 1
{

 
public 
IPostDal 

GetPostDal "
(" #
string# )
	tableName* 3
)3 4
{ 	
return 
	tableName 
switch #
{ 
$str &
=>' )
(* +
IPostDal+ 3
)3 4
new4 7'
ComprehensiveSectionPostDal8 S
(S T
)T U
,U V
_ 
=> 
throw 
new 
	Exception (
(( )
$str) ;
); <
} 
; 
} 	
} 
} ◊
6E:\CX\WebapiDemo\WebApiDemo.DAL\Interfaces\IPostDal.cs
	namespace 	

WebApiDemo
 
. 
DAL 
. 

Interfaces #
;# $
public 
	interface 
IPostDal 
{ 
List 
< 	
Post	 
? 
> 
? 
GetAllPosts 
( 
) 
; 
List

 
<

 	
Post

	 
?

 
>

 
?

 
GetPosts

 
(

 
int

 
beginNum

 &
,

& '
int

( +
needNum

, 3
)

3 4
;

4 5
List 
< 	
Post	 
? 
> 
? 
GetPosts 
( 
int 

mainPostId (
)( )
;) *
Post 
? 	
GetPostById
 
( 
int 
id 
) 
; 
int 
AddPost 
( 
Post 
post 
) 
; 
void 
SetMainPost	 
( 
int 
id 
) 
; 
List 
< 	

UserBModel	 
? 
> 
? 
GetAllUsers "
(" #
)# $
;$ %
List 
< 	

UserBModel	 
? 
> 
? 
GetUsers 
(  
int  #
beginNum$ ,
,, -
int. 1
needNum2 9
)9 :
;: ;
Post 
? 	
GetLastReplyPosts
 
( 
int 

mainPostId  *
)* +
;+ ,
List 
< 	
Post	 
> 
? 
GetMainPosts 
( 
) 
; 
void 

UpdatePost	 
( 
Post 
post 
) 
; 
} π
=E:\CX\WebapiDemo\WebApiDemo.DAL\Interfaces\IPostDalFactory.cs
	namespace 	

WebApiDemo
 
. 
DAL 
. 

Interfaces #
{ 
public 

	interface 
IPostDalFactory $
{ 
IPostDal 

GetPostDal 
( 
string "
	tableName# ,
), -
;- .
} 
}		 Ó+
8E:\CX\WebapiDemo\WebApiDemo.DAL\Mapper\UserBToDMapper.cs
	namespace 	

WebApiDemo
 
. 
DAL 
. 
Mapper 
{ 
public 

static 
class 
UserBToDMapper &
{ 
public		 
static		 
User		 
UpdateFromBModel		 +
(		+ ,
this		, 0
User		1 5
user		6 :
,		: ;

UserBModel		< F

userBModel		G Q
)		Q R
{

 	
user 
. 
Id 
= 

userBModel  
.  !
Id! #
;# $
if 
( 

userBModel 
. 
UserName #
!=$ &
null' +
)+ ,
{ 
user 
. 
UserName 
= 

userBModel  *
.* +
UserName+ 3
;3 4
} 
if 
( 

userBModel 
. 
Password #
!=$ &
null' +
)+ ,
{ 
user 
. 
Password 
= 

userBModel  *
.* +
Password+ 3
;3 4
} 
if 
( 

userBModel 
. 
NickName #
!=$ &
null' +
)+ ,
{ 
user 
. 
NickName 
= 

userBModel  *
.* +
NickName+ 3
;3 4
} 
if 
( 

userBModel 
. 
Gender !
!=" $
null% )
)) *
{ 
user 
. 
Gender 
= 
Enum "
." #
TryParse# +
<+ ,
Gender, 2
>2 3
(3 4

userBModel4 >
.> ?
Gender? E
,E F
outG J
varK N
parsedGenderO [
)[ \
? 
parsedGender "
:   
(   
Gender   
?   
)   
null   #
;  # $
}!! 
if## 
(## 

userBModel## 
.## 
	Signature## $
!=##% '
null##( ,
)##, -
{$$ 
user%% 
.%% 
	Signature%% 
=%%  

userBModel%%! +
.%%+ ,
	Signature%%, 5
;%%5 6
}&& 
if(( 
((( 

userBModel(( 
.(( 
Avatar(( !
!=((" $
null((% )
)(() *
{)) 
user** 
.** 
Avatar** 
=** 

userBModel** (
.**( )
Avatar**) /
;**/ 0
}++ 
user-- 
.-- 
LastLoginTime-- 
=--  

userBModel--! +
.--+ ,
LastLoginTime--, 9
;--9 :
user// 
.// 
	UserLevel// 
=// 

userBModel// '
.//' (
	UserLevel//( 1
;//1 2
user11 
.11 
Points11 
=11 

userBModel11 $
.11$ %
Points11% +
;11+ ,
user33 
.33 
	IsDeleted33 
=33 

userBModel33 '
.33' (
	IsDeleted33( 1
;331 2
return55 
user55 
;55 
}66 	
public88 
static88 
User88 
ToUser88 !
(88! "
this88" &

UserBModel88' 1

userBModel882 <
)88< =
{99 	
return:: 
new:: 
User:: 
{;; 
Id<< 
=<< 

userBModel<< 
.<<  
Id<<  "
,<<" #
UserName== 
=== 

userBModel== %
.==% &
UserName==& .
??==/ 1
string==2 8
.==8 9
Empty==9 >
,==> ?
Password>> 
=>> 

userBModel>> %
.>>% &
Password>>& .
??>>/ 1
string>>2 8
.>>8 9
Empty>>9 >
,>>> ?
NickName?? 
=?? 

userBModel?? %
.??% &
NickName??& .
,??. /
Gender@@ 
=@@ 
Enum@@ 
.@@ 
TryParse@@ &
<@@& '
Gender@@' -
>@@- .
(@@. /

userBModel@@/ 9
.@@9 :
Gender@@: @
,@@@ A
out@@B E
var@@F I
parsedGender@@J V
)@@V W
?AA 
parsedGenderAA "
:BB 
(BB 
GenderBB 
?BB 
)BB 
nullBB #
,BB# $
	SignatureCC 
=CC 

userBModelCC &
.CC& '
	SignatureCC' 0
,CC0 1
AvatarDD 
=DD 

userBModelDD #
.DD# $
AvatarDD$ *
,DD* +
LastLoginTimeEE 
=EE 

userBModelEE  *
.EE* +
LastLoginTimeEE+ 8
,EE8 9
	UserLevelFF 
=FF 

userBModelFF &
.FF& '
	UserLevelFF' 0
,FF0 1
PointsGG 
=GG 

userBModelGG #
.GG# $
PointsGG$ *
,GG* +
	IsDeletedHH 
=HH 

userBModelHH &
.HH& '
	IsDeletedHH' 0
}II 
;II 
}JJ 	
}KK 
}LL ∏
8E:\CX\WebapiDemo\WebApiDemo.DAL\Mapper\UserDToBMapper.cs
	namespace 	

WebApiDemo
 
. 
DAL 
. 
Mapper 
{ 
public 

static 
class 
UserDToBMapper &
{ 
public		 
static		 

UserBModel		  
?		  !
ToUserBModel		" .
(		. /
this		/ 3
User		4 8
user		9 =
)		= >
{

 	
if 
( 
user 
== 
null 
) 
{ 
return 
null 
; 
} 
return 
new 

UserBModel !
{ 
Id 
= 
user 
. 
Id 
, 
UserName 
= 
user 
.  
UserName  (
,( )
Password 
= 
user 
.  
Password  (
,( )
NickName 
= 
user 
.  
NickName  (
,( )
Gender 
= 
user 
. 
Gender $
.$ %
ToString% -
(- .
). /
,/ 0
	Signature 
= 
user  
.  !
	Signature! *
,* +
Avatar 
= 
user 
. 
Avatar $
,$ %
RegisterTime 
= 
user #
.# $
RegisterTime$ 0
,0 1
LastLoginTime 
= 
user  $
.$ %
LastLoginTime% 2
,2 3
	UserLevel 
= 
user  
.  !
	UserLevel! *
,* +
Points 
= 
user 
. 
Points $
,$ %
	IsDeleted 
= 
user  
.  !
	IsDeleted! *
} 
; 
} 	
public!! 
static!! 

UserBModel!!  
?!!  !
ToPublicUserBModel!!" 4
(!!4 5
this!!5 9
User!!: >
user!!? C
)!!C D
{"" 	
if## 
(## 
user## 
==## 
null## 
)## 
{$$ 
return%% 
null%% 
;%% 
}&& 
return'' 
new'' 

UserBModel'' !
{(( 
Id)) 
=)) 
user)) 
.)) 
Id)) 
,)) 
UserName** 
=** 
user** 
.**  
UserName**  (
,**( )
NickName++ 
=++ 
user++ 
.++  
NickName++  (
,++( )
Gender,, 
=,, 
user,, 
.,, 
Gender,, $
.,,$ %
ToString,,% -
(,,- .
),,. /
,,,/ 0
	Signature-- 
=-- 
user--  
.--  !
	Signature--! *
,--* +
Avatar.. 
=.. 
user.. 
... 
Avatar.. $
,..$ %
RegisterTime// 
=// 
user// #
.//# $
RegisterTime//$ 0
,//0 1
LastLoginTime00 
=00 
user00  $
.00$ %
LastLoginTime00% 2
,002 3
	UserLevel11 
=11 
user11  
.11  !
	UserLevel11! *
,11* +
Points22 
=22 
user22 
.22 
Points22 $
,22$ %
	IsDeleted33 
=33 
user33  
.33  !
	IsDeleted33! *
}44 
;44 
}55 	
}66 
}77 —
-E:\CX\WebapiDemo\WebApiDemo.DAL\SectionDal.cs
	namespace 	

WebApiDemo
 
. 
DAL 
; 
public 
class 

SectionDal 
{		 
public 

static 
List 
< 
Section 
> 
?  
GetAllSections! /
(/ 0
)0 1
{ 
using 
var 
context 
= 
DbContextFactory ,
., -
GetDbContext- 9
(9 :
): ;
;; <
var 
sections 
= 
context 
. 
Sections '
.' (
ToList( .
(. /
)/ 0
;0 1
if 

( 
sections 
== 
null 
) 
{ 	
return 
null 
; 
} 	
return 
sections 
; 
} 
public 

static 
Section 
? 
GetSectionById )
() *
int* -
id. 0
)0 1
{ 
using 
var 
context 
= 
DbContextFactory ,
., -
GetDbContext- 9
(9 :
): ;
;; <
return 
context 
. 
Sections 
.  
Find  $
($ %
id% '
)' (
;( )
} 
} È`
*E:\CX\WebapiDemo\WebApiDemo.DAL\UserDal.cs
	namespace 	

WebApiDemo
 
. 
DAL 
; 
public		 
class		 
UserDal		 
{

 
public 

static 
List 
< 

UserBModel !
?! "
>" #
?# $
DebugGetAllUsers% 5
(5 6
)6 7
{ 
using 
var 
context 
= 
DbContextFactory ,
., -
GetDbContext- 9
(9 :
): ;
;; <
var 
users 
= 
context 
. 
Users !
.! "
ToList" (
(( )
)) *
;* +
if 

( 
users 
== 
null 
) 
{ 	
return 
null 
; 
} 	
return 
users 
. 
Select 
( 
user  
=>! #
user$ (
.( )
ToUserBModel) 5
(5 6
)6 7
)7 8
.8 9
ToList9 ?
(? @
)@ A
;A B
} 
public 
static 

UserBModel  
?  !
DebugGetUserById" 2
(2 3
int3 6
id7 9
)9 :
{ 
using 
var 
context 
= 
DbContextFactory ,
., -
GetDbContext- 9
(9 :
): ;
;; <
return 
context 
. 
Users 
. 
Find !
(! "
id" $
)$ %
?% &
.& '
ToUserBModel' 3
(3 4
)4 5
;5 6
} 
public 

static 

UserBModel 
? 
GetUserById )
() *
int* -
id. 0
)0 1
{ 
using 
var 
context 
= 
DbContextFactory ,
., -
GetDbContext- 9
(9 :
): ;
;; <
return 
context 
. 
Users 
. 
Find !
(! "
id" $
)$ %
?% &
.& '
ToPublicUserBModel' 9
(9 :
): ;
;; <
}   
public"" 

static"" 
List"" 
<"" 

UserBModel"" !
?""! "
>""" #
?""# $(
GetUserByUserNameAndPassword""% A
(""A B
string""B H
userName""I Q
,""Q R
string""S Y
password""Z b
)""b c
{## 
using$$ 
var$$ 
context$$ 
=$$ 
DbContextFactory$$ ,
.$$, -
GetDbContext$$- 9
($$9 :
)$$: ;
;$$; <
var%% 
users%% 
=%% 
context%% 
.%% 
Users%% !
.%%! "
Where%%" '
(%%' (
user%%( ,
=>%%- /
user%%0 4
.%%4 5
UserName%%5 =
==%%> @
userName%%A I
&&%%J L
user%%M Q
.%%Q R
Password%%R Z
==%%[ ]
password%%^ f
)%%f g
.%%g h
ToList%%h n
(%%n o
)%%o p
;%%p q
if&& 

(&& 
users&& 
==&& 
null&& 
)&& 
{'' 	
return(( 
null(( 
;(( 
})) 	
return** 
users** 
.** 
Select** 
(** 
user**  
=>**! #
user**$ (
.**( )
ToUserBModel**) 5
(**5 6
)**6 7
)**7 8
.**8 9
ToList**9 ?
(**? @
)**@ A
;**A B
}++ 
public.. 

static.. 
string.. "
GenerateAutoLoginToken.. /
(../ 0
int..0 3
userId..4 :
)..: ;
{// 
using00 
var00 
context00 
=00 
DbContextFactory00 ,
.00, -
GetDbContext00- 9
(009 :
)00: ;
;00; <
var11 
user11 
=11 
context11 
.11 
Users11  
.11  !
Find11! %
(11% &
userId11& ,
)11, -
;11- .
if22 

(22 
user22 
==22 
null22 
)22 
{33 	
return44 
string44 
.44 
Empty44 
;44  
}55 	
string66 
token66 
=66 
Guid66 
.66 
NewGuid66 #
(66# $
)66$ %
.66% &
ToString66& .
(66. /
)66/ 0
;660 1
context77 
.77 

AuthTokens77 
.77 
Add77 
(77 
new77 "
	AuthToken77# ,
{88 	
UserId99 
=99 
userId99 
,99 
Token:: 
=:: 
token:: 
,:: 

ExpireTime;; 
=;; 
DateTime;; !
.;;! "
Now;;" %
.;;% &
AddDays;;& -
(;;- .
$num;;. /
);;/ 0
}<< 	
)<<	 

;<<
 
context== 
.== 
SaveChanges== 
(== 
)== 
;== 
return>> 
token>> 
;>> 
}?? 
publicBB 

staticBB 
intBB 
CheckAutoLoginTokenBB )
(BB) *
stringBB* 0
tokenBB1 6
)BB6 7
{CC 
usingDD 
varDD 
contextDD 
=DD 
DbContextFactoryDD ,
.DD, -
GetDbContextDD- 9
(DD9 :
)DD: ;
;DD; <
varEE 
	authTokenEE 
=EE 
contextEE 
.EE  

AuthTokensEE  *
.EE* +
FirstOrDefaultEE+ 9
(EE9 :
	authTokenEE: C
=>EED F
	authTokenEEG P
.EEP Q
TokenEEQ V
==EEW Y
tokenEEZ _
)EE_ `
;EE` a
ifFF 

(FF 
	authTokenFF 
==FF 
nullFF 
)FF 
{GG 	
returnHH 
-HH 
$numHH 
;HH 
}II 	
ifJJ 

(JJ 
	authTokenJJ 
.JJ 

ExpireTimeJJ  
<JJ! "
DateTimeJJ# +
.JJ+ ,
NowJJ, /
)JJ/ 0
{KK 	
contextLL 
.LL 

AuthTokensLL 
.LL 
RemoveLL %
(LL% &
	authTokenLL& /
)LL/ 0
;LL0 1
contextMM 
.MM 
SaveChangesMM 
(MM  
)MM  !
;MM! "
returnNN 
-NN 
$numNN 
;NN 
}OO 	
returnPP 
	authTokenPP 
.PP 
UserIdPP 
;PP  
}QQ 
publicRR 

staticRR 
boolRR 
CheckUserExistRR %
(RR% &
stringRR& ,
userNameRR- 5
)RR5 6
{SS 
usingTT 
varTT 
contextTT 
=TT 
DbContextFactoryTT ,
.TT, -
GetDbContextTT- 9
(TT9 :
)TT: ;
;TT; <
returnUU 
contextUU 
.UU 
UsersUU 
.UU 
AnyUU  
(UU  !
userUU! %
=>UU& (
userUU) -
.UU- .
UserNameUU. 6
==UU7 9
userNameUU: B
)UUB C
;UUC D
}VV 
publicXX 

staticXX 
intXX 
AddUserXX 
(XX 

UserBModelXX (

userBModelXX) 3
)XX3 4
{YY 
usingZZ 
varZZ 
contextZZ 
=ZZ 
DbContextFactoryZZ ,
.ZZ, -
GetDbContextZZ- 9
(ZZ9 :
)ZZ: ;
;ZZ; <
context[[ 
.[[ 
Users[[ 
.[[ 
Add[[ 
([[ 

userBModel[[ $
.[[$ %
ToUser[[% +
([[+ ,
)[[, -
)[[- .
;[[. /
context\\ 
.\\ 
SaveChanges\\ 
(\\ 
)\\ 
;\\ 
return]] 
context]] 
.]] 
Users]] 
.]] 
Max]]  
(]]  !
user]]! %
=>]]& (
user]]) -
.]]- .
Id]]. 0
)]]0 1
;]]1 2
}__ 
publicaa 

staticaa 
intaa 

UpdateUseraa  
(aa  !

UserBModelaa! +

userBModelaa, 6
)aa6 7
{bb 
usingcc 
varcc 
contextcc 
=cc 
DbContextFactorycc ,
.cc, -
GetDbContextcc- 9
(cc9 :
)cc: ;
;cc; <
vardd 
userToUpdatedd 
=dd 
contextdd "
.dd" #
Usersdd# (
.dd( )
Finddd) -
(dd- .

userBModeldd. 8
.dd8 9
Iddd9 ;
)dd; <
;dd< =
ifee 

(ee 
userToUpdateee 
==ee 
nullee  
)ee  !
{ff 	
returngg 
$numgg 
;gg 
}hh 	
contextii 
.ii 
Usersii 
.ii 
Updateii 
(ii 
userToUpdateii )
.ii) *
UpdateFromBModelii* :
(ii: ;

userBModelii; E
)iiE F
)iiF G
;iiG H
returnjj 
contextjj 
.jj 
SaveChangesjj "
(jj" #
)jj# $
;jj$ %
}kk 
publicnn 

staticnn 
intnn 

RemoveUsernn  
(nn  !
intnn! $
idnn% '
)nn' (
{oo 
usingpp 
varpp 
contextpp 
=pp 
DbContextFactorypp ,
.pp, -
GetDbContextpp- 9
(pp9 :
)pp: ;
;pp; <
varqq 
userToRemoveqq 
=qq 
contextqq "
.qq" #
Usersqq# (
.qq( )
Findqq) -
(qq- .
idqq. 0
)qq0 1
;qq1 2
ifrr 

(rr 
userToRemoverr 
==rr 
nullrr  
)rr  !
{ss 	
returntt 
$numtt 
;tt 
}uu 	
contextvv 
.vv 
Usersvv 
.vv 
Removevv 
(vv 
userToRemovevv )
)vv) *
;vv* +
returnww 
contextww 
.ww 
SaveChangesww "
(ww" #
)ww# $
;ww$ %
}xx 
public{{ 

static{{ 
void{{ 
UpdateLastLoginTime{{ *
({{* +
int{{+ .
id{{/ 1
){{1 2
{|| 
using}} 
var}} 
context}} 
=}} 
DbContextFactory}} ,
.}}, -
GetDbContext}}- 9
(}}9 :
)}}: ;
;}}; <
var~~ 
user~~ 
=~~ 
context~~ 
.~~ 
Users~~  
.~~  !
Find~~! %
(~~% &
id~~& (
)~~( )
;~~) *
if 

( 
user 
== 
null 
) 
{
ÄÄ 	
return
ÅÅ 
;
ÅÅ 
}
ÇÇ 	
user
ÉÉ 
.
ÉÉ 
LastLoginTime
ÉÉ 
=
ÉÉ 
DateTime
ÉÉ %
.
ÉÉ% &
Now
ÉÉ& )
;
ÉÉ) *
context
ÑÑ 
.
ÑÑ 
Users
ÑÑ 
.
ÑÑ 
Update
ÑÑ 
(
ÑÑ 
user
ÑÑ !
)
ÑÑ! "
;
ÑÑ" #
context
ÖÖ 
.
ÖÖ 
SaveChanges
ÖÖ 
(
ÖÖ 
)
ÖÖ 
;
ÖÖ 
}
ÜÜ 
}áá 