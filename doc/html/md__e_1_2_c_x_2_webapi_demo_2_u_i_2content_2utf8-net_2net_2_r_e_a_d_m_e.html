<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WebApiDoc: UEditor ASP.NET 后台使用说明</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">WebApiDoc<span id="projectnumber">&#160;v1.0</span>
   </div>
   <div id="projectbrief">WebApi 后端项目文档</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','搜索',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__e_1_2_c_x_2_webapi_demo_2_u_i_2content_2utf8-net_2net_2_r_e_a_d_m_e.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">载入中...</div>
<div class="SRStatus" id="Searching">搜索中...</div>
<div class="SRStatus" id="NoMatches">未找到</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">UEditor ASP.NET 后台使用说明</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md24"></a>
背景</h1>
<p>UEditor 在 1.4 版本之后进行了一次前后端统一配置的整理，.Net 的后台也进行了一次重写，跟之前的版本差别较大，升级的用户注意阅读本文档。</p>
<p>本文档介绍 UEditor ASP.NET 后台的部署、配置、源码说明。</p>
<h1><a class="anchor" id="autotoc_md25"></a>
1. 部署说明</h1>
<h2><a class="anchor" id="autotoc_md26"></a>
1.1. 安装并注册 .NET Framework 4.0</h2>
<p>代码的运行时环境是 .NET Framework 4.0，首先要确认 IIS 已经安装了 .NET 4.0 的运行时框架。方法是打开「IIS 管理器」，选择根目录下的「应用程序池」，在右侧查看是否有一个应用程序池的版本是 v4.0，如果存在，则 IIS 已经安装了所需的运行时环境，此时读者可以跳过本节。</p>
<p><img src="../_doc/images/net-publish-1.png" alt="检查 .NET 4.0 安装情况" class="inline"/></p>
<p>如果没有找到对应的应用程序池，需要手动安装。</p>
<p>Windows 7 和 Windows Server 2008 R2 默认安装了 .Net Framework 4.0，如果是 Server 03 和老掉牙的 Windows XP，则需要手动安装 <a href="http://www.microsoft.com/zh-cn/download/details.aspx?id=17718">.NET Framework 4.0</a>。</p>
<p>安装完 .NET Framework 4.0 后，还需要向 IIS 注册应用程序池，注册的方法是，使用**管理员权限**打开命令提示符（CMD），输入以下命令：</p>
<div class="fragment"><div class="line">C:\Windows\Microsoft.NET\Framework\v4.0.30319\aspnet_regiis -i</div>
</div><!-- fragment --><p>安装完毕后，在 IIS 管理器刷新就能看到 4.0 的应用程序池。</p>
<h2><a class="anchor" id="autotoc_md27"></a>
1.2. 设置 .NET 应用程序</h2>
<p>代码要求以应用程序的形式来运行（可以方便加入库依赖和组织代码）。需要把 <code>net</code> 目录转换为应用程序。</p>
<ol type="1">
<li><p class="startli">在 IIS 中，展开到 <code>ueditor/net</code> 目录，在目录上右击，点击「转换为应用程序」。</p>
<p class="startli"><img src="../_doc/images/net-publish-2.png" alt="转换为应用程序" class="inline"/></p>
</li>
<li><p class="startli">弹出的对话框中，点击「选择...」来指定使用的应用程序池。选择版本为 4.0 的应用程序池，然后点确定。</p>
<p class="startli"><img src="../_doc/images/net-publish-3.png" alt="选择应用程序池" class="inline"/></p>
</li>
<li><p class="startli">设置连接凭据。点击「链接为...」按钮，在弹出的对话框中指定一个对目录具有读写权限的用户（如 administrator），然后点确定。</p>
<p class="startli"><img src="../_doc/images/net-publish-4.png" alt="设置连接凭据" class="inline"/></p>
<p class="startli">设置完毕后，可以点击「测试设置...」来测试权限是否正常。</p>
<p class="startli"><img src="../_doc/images/net-publish-5.png" alt="设置连接凭据" class="inline"/></p>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md28"></a>
1.3. 运行测试</h2>
<p>在浏览器中运行 <code>net/controller.ashx</code>，如果返回 "`{"state":"action 参数为空或者 action 不被支持。"}`"，则表示应用程序运行成功。</p>
<p>如果你确认上述步骤已经执行，但是依然有问题，请给我们<a href="https://github.com/fex-team/ueditor/issues/new?labels=NET%E5%90%8E%E5%8F%B0">提 Issue</a>，我们会尽快答复解决。</p>
<h1><a class="anchor" id="autotoc_md29"></a>
2. 配置说明</h1>
<p>前后端配置统一之后，配置文件由后台读取，返回给前端。但是部分配置是给后台使用的。</p>
<h2><a class="anchor" id="autotoc_md30"></a>
2.1. 上传配置说明</h2>
<p>关于上传的部分，后台需要关心以下模板的配置项。</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;{tpl}FieldName&quot;: &quot;upfile&quot;,</div>
<div class="line">    &quot;{tpl}PathFormat&quot;: &quot;upload/{tpl}/{yyyy}{mm}{dd}/{time}{rand:6}&quot;,</div>
<div class="line">    &quot;{tpl}UrlPrefix&quot;: &quot;/ueditor/net/&quot;,</div>
<div class="line">    &quot;{tpl}AllowFiles&quot;: [&quot;.png&quot;, &quot;.jpg&quot;, &quot;.jpeg&quot;, &quot;.gif&quot;, &quot;.bmp&quot;],</div>
<div class="line">    &quot;{tpl}MaxSize&quot;: 2048000</div>
<div class="line">}</div>
</div><!-- fragment --><p>"{tpl}FieldName" 表示提交的表单的文件域名称。</p>
<p>"{tpl}PathFormat" 表示上传文件保存的路径和名称。注意，这里的路径是相对应用程序的，如果需要修改的话，请自行修改源码。</p>
<p>"{tpl}UrlPrefix" 表示上传文件访问的 URL 前缀。注意，这里应该给出应用程序的 URL 路径，否则上传的文件不能正确定位。</p>
<blockquote class="doxtable">
<p>&zwj;举个例子，如果你的 UEditor 的位置在 <code><a href="http://www.mydomain.com/myapp/ueditor">http://www.mydomain.com/myapp/ueditor</a></code>，对应的本地路径是 <code>C:\iis_pub\www\myapp\ueditor</code>，那么 .NET 应用程序的位置在 <code><a href="http://www.mydomain.com/myapp/ueditor/net">http://www.mydomain.com/myapp/ueditor/net</a></code>，对应的本地路径是 <code>C:\iis_pub\www\myapp\ueditor\net</code>。图片上传配置项应该如下：</p>
<p>{ "imagePathFormat": "upload/image/{yyyy}{mm}{dd}/{time}{rand:6}", "imageUrlPrefix": "/myapp/ueditor/net/", }</p>
<p>上传的文件会保存在 <code>C:\iis_pub\www\myapp\ueditor\net\upload\image\{日期}\{文件名}</code> </p>
</blockquote>
<p>"{tpl}AllowFiles" 限制文件上传的类型，注意要有 "."。</p>
<p>"{tpl}MaxSize" 限制文件上传的大小。注意这里的限制是代码上的判断，应用程序本身还有一个请求报文大小限制。该限制在 web.config 文件中修改，注意要有以下的节：</p>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">configuration</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">system.web</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">httpRuntime</span> <span class="keyword">requestValidationMode</span>=<span class="stringliteral">&quot;2.0&quot;</span> <span class="keyword">maxRequestLength</span>=<span class="stringliteral">&quot;102400&quot;</span> /&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">system.web</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">configuration</span>&gt;</div>
</div><!-- fragment --><p>maxRequestLength 就是请求报文大小限制，该大小应该要比设置的所有上传大小都大，否则应用程序执行之前，请求会被被拒绝。</p>
<h1><a class="anchor" id="autotoc_md31"></a>
3. 源码说明</h1>
<p>可以看到 net 目录内的源码结构是这样的：</p>
<div class="fragment"><div class="line">net</div>
<div class="line">    App_Code</div>
<div class="line">        Config.cs</div>
<div class="line">        Handler.cs</div>
<div class="line">        PathFormatter.cs</div>
<div class="line">        *Handler.cs</div>
<div class="line">    Bin</div>
<div class="line">        Newtonsoft.Json.dll</div>
<div class="line">    config.json</div>
<div class="line">    controller.ashx</div>
<div class="line">    net.sln</div>
<div class="line">    README.md</div>
<div class="line">    Web.config</div>
</div><!-- fragment --><p>App_Code 上的文件是应用程序的源码。</p>
<ul>
<li><a class="el" href="_config_8cs.html">Config.cs</a> 负责读取配置文件</li>
<li><a class="el" href="_handler_8cs.html">Handler.cs</a> 是请求处理器的基类，提供了一些基本对象的访问以及输出控制。如果需要增加处理器，应该从该基类继承</li>
<li>PathFormatter.cs 解析 PathFormat，把信息填充为运行时信息。</li>
<li>*Handler.cs 是各种处理器，处理各种 UEditor 需要的请求。</li>
</ul>
<p>Bin 里面的是应用程序的依赖库，当前依赖 Newtonsoft 的 Json 库。Bin 目录和 App_Code 目录受应用程序保护，不用担心被用户访问到。</p>
<p>config.json 是 UEditor 后端的配置文件，上一节已经介绍了比较重要的配置项。</p>
<p>controller.ashx 是 UEditor 请求的入口，它把不同的 action 分发到不同的 <a class="el" href="class_handler.html" title="Handler 的摘要说明">Handler</a> 来处理。</p>
<p>net.sln 是项目的解决方案文件，安装 Visual Studio 2013 或以上的机器可以打开进行项目的改造。</p>
<p>README.md 是本说明文件。</p>
<p>Web.config 是应用程序的配置文件。 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">制作者 <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
